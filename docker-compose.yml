version: '3.8'

services:
  nginx:
    build: .
    ports:
      - "80:80"
      - "443:443"
    container_name: blackperl-pathways-learn
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    # The command starts nginx and reloads it every 6 hours
    # to pick up renewed certificates.
    command: >
      /bin/sh -c "
        while :; do
          sleep 6h &
          wait $${!};
          nginx -s reload;
        done &
        nginx -g 'daemon off;'
      "

  certbot:
    image: certbot/certbot
    volumes:
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    # The entrypoint runs certbot renew every 12 hours.
    entrypoint: >
      /bin/sh -c "
        trap exit TERM;
        while :; do
          certbot renew;
          sleep 12h &
          wait $${!};
        done;
      "
